# Troubleshooting Case: Installing SSL certificates on Synology
# 故障排除实战案例: 在群晖/黑群晖上安装SSL证书


### 0. 目标 ###
由于Synology（群晖）的系统在多处需要使用SSL证书，比如其自身的5001管理员HTTPS界面，或者443的网站界面，或者WebDAV等……DSM系统在出厂时内置一份由Synology公司颁布的证书，但是这个证书与机器的域名不匹配，所以不建议使用，故而需要自己重新申请一个。我们这次的目标是已经通过yourdomain.name生成一个key和对应的csr，并且通过API提交到letsencrypt.com上，请求一个证书，并且把这个证书部署到群晖上。

“不就是申请和部署一个证书嘛！”听起来很简单，是不？

然而，真正撸起袖子干起来，才体会到这其中困难重重，一个坑接一个坑。一共花了将近一整天的时间才最终搞定。为了纪念逝去的时间，现将钻研过程中遇到的心得分享于此。

### 1. 起因 ###
公司的网管已经在防火墙上禁了File Sharing / SMB 的端口，导致在公司以外就无法访问文件共享，因而只得通过在群晖上安装并启用WebDAV方式的文件共享。群晖的共享很好地与WebDAV集成，因此在群晖的共享文件夹上启用WebDAV并不复杂，但是随之而来带来又一个问题：在Windows上没有WebDAV的客户端————要么用第三方付费的软件，要么用Windows的网络映射（Map network drive），但是后者需要强制使用HTTPS。总之，部署证书的目的：
* 为了直接在Windows客户端上访问通过WebDAV共享出来的文件
* 为了以后的443端口的HTTPS网站
* 为了管理界面登录时浏览器状态栏不显示红字（强迫症，呵呵）

### 2. 预热 ###
起初在公司以外发现无法访问公司群晖上HTTP WEB网站，还以为是系统的设置问题————于是花了很多时间在设置的排查上：
* 先是看群晖自己是不是防火墙，后来发现群晖DSM没有防火墙；
* 接着又以为是nginx的什么设置出错了，导致80端口没有设置正常，于是去把WebStation包卸载又重装，但是80端口依旧无法访问；又把apache 2.2和2.4给装上，故障照旧。
* 无法telnet 80端口，说明肯定是连接断了，而不是应用层的内部错误；
* 让同事在公司内部访问HTTP网站，成功；
* 联系了公司的网管，他让我把一些操作重复做了N遍，以反复确认……

折腾至此，得到的结论是:
1. 80和443的TCP端口被封了，不是公司网管封的，而是ISP（市级联通）把WEB的默认端口给封了，需要另行向ISP申请才能开通
2. 公司网管把SMB文件共享的端口给封了，不值得打单独开放的申请报告；还是老老实实用WebDAV比较好，虽然WebDAV有各种问题

### 3. 过程 ###
有多种方式可以给群晖的DSM装上证书，但是大部分是死路或过于麻烦

1. 在，比如[这里](https://miketabor.com/install-a-lets-encrypt-ssl-on-a-synology-nas/)、[这里](https://synoguide.com/2016/04/14/secure-your-synology-with-https-ssl-certificate-from-lets-encrypt/)

### 4. 后记 ###
1. 在通过WebDAV往群晖上面上传文件时，经常会出现某个文件出错的情况，这时候需要把文件改名，再上传，再通过web管理员界面登录进行调整。不知道这是不是Windows或者Win 7的问题，还是群晖WebDAV服务的问题，总之这个问题存在，而且还时不时遇到。
2. 在 管理web界面 -> Control Panel -> Security -> Certificate 这里，单纯把新的证书给Add上并且设置为Default还不够，还需要按下“Configure”按钮，
3. 虽然管理的web界面已经配置并关联了证书，但是客户端浏览器在访问的时候还是需要隔一段时间才会不显示红色（有可能是隔天），这个大概是chrome浏览器的设置

### 5. 后记的后记 ###
由于通过let's encrypt申请的免费证书只有3个到时候可能还会考虑开通80端口
